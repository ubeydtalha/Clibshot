#!/usr/bin/env python3
"""
ClipShot CLI - Plugin Development Tool

A command-line tool for creating, testing, and managing ClipShot plugins.
"""

import argparse
import sys
import shutil
from pathlib import Path
from typing import Optional
import json


def create_plugin(name: str, language: str, output_dir: Optional[Path] = None) -> None:
    """
    Create a new plugin from template.
    
    Args:
        name: Plugin name (will be used to generate ID)
        language: Plugin language (python, rust, cpp)
        output_dir: Output directory (default: ./plugins/{name})
    """
    # Validate language
    valid_languages = ["python", "rust", "cpp"]
    if language not in valid_languages:
        print(f"Error: Invalid language '{language}'. Must be one of: {', '.join(valid_languages)}")
        sys.exit(1)
    
    # Determine paths
    script_dir = Path(__file__).parent
    repo_root = script_dir.parent.parent
    template_dir = repo_root / "plugins" / "templates" / f"{language}-template"
    
    if not template_dir.exists():
        print(f"Error: Template directory not found: {template_dir}")
        sys.exit(1)
    
    # Generate plugin ID from name
    plugin_id = f"com.example.{name.lower().replace(' ', '-')}"
    
    # Determine output directory
    if output_dir is None:
        output_dir = Path.cwd() / "plugins" / name.lower().replace(' ', '-')
    
    # Check if output directory already exists
    if output_dir.exists():
        print(f"Error: Directory already exists: {output_dir}")
        sys.exit(1)
    
    # Copy template
    print(f"Creating {language} plugin '{name}'...")
    print(f"  Template: {template_dir}")
    print(f"  Output:   {output_dir}")
    
    shutil.copytree(template_dir, output_dir)
    
    # Update manifest.json
    manifest_file = output_dir / "manifest.json"
    if manifest_file.exists():
        with open(manifest_file, 'r') as f:
            manifest = json.load(f)
        
        manifest["id"] = plugin_id
        manifest["name"] = name
        
        with open(manifest_file, 'w') as f:
            json.dump(manifest, f, indent=2)
        
        print(f"  ✓ Updated manifest.json with ID: {plugin_id}")
    
    print(f"\n✅ Plugin created successfully!")
    print(f"\nNext steps:")
    print(f"  1. cd {output_dir}")
    print(f"  2. Edit manifest.json to customize your plugin")
    print(f"  3. Implement your plugin in src/")
    print(f"  4. Test your plugin")
    
    if language == "python":
        print(f"     pytest tests/")
    elif language == "rust":
        print(f"     maturin develop")
        print(f"     cargo test")
    elif language == "cpp":
        print(f"     mkdir build && cd build")
        print(f"     cmake .. && cmake --build .")


def validate_manifest(manifest_path: Path) -> None:
    """
    Validate a plugin manifest file.
    
    Args:
        manifest_path: Path to manifest.json
    """
    if not manifest_path.exists():
        print(f"Error: Manifest not found: {manifest_path}")
        sys.exit(1)
    
    print(f"Validating manifest: {manifest_path}")
    
    try:
        with open(manifest_path, 'r') as f:
            manifest = json.load(f)
        
        # Check required fields
        required_fields = ["id", "name", "version", "api_version", "type", "category"]
        missing_fields = []
        
        for field in required_fields:
            if field not in manifest:
                missing_fields.append(field)
        
        if missing_fields:
            print(f"❌ Validation failed!")
            print(f"   Missing required fields: {', '.join(missing_fields)}")
            sys.exit(1)
        
        # Check ID format
        if not manifest["id"].startswith(("com.", "org.", "net.")):
            print(f"⚠️  Warning: Plugin ID should use reverse domain notation (e.g., com.example.plugin)")
        
        # Check version format
        version = manifest["version"]
        if not all(part.isdigit() for part in version.split(".")):
            print(f"⚠️  Warning: Version should follow semantic versioning (e.g., 1.0.0)")
        
        print(f"✅ Manifest is valid!")
        print(f"\nPlugin Info:")
        print(f"  ID:      {manifest['id']}")
        print(f"  Name:    {manifest['name']}")
        print(f"  Version: {manifest['version']}")
        print(f"  Type:    {manifest['type']}")
        
    except json.JSONDecodeError as e:
        print(f"❌ Invalid JSON: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"❌ Validation error: {e}")
        sys.exit(1)


def main():
    """Main entry point for the CLI."""
    parser = argparse.ArgumentParser(
        description="ClipShot Plugin Development CLI",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Create a new Python plugin
  clipshot create my-plugin --language python
  
  # Create a new Rust plugin
  clipshot create my-rust-plugin --language rust
  
  # Validate a manifest
  clipshot validate ./plugins/my-plugin/manifest.json
  
  # Get help for a command
  clipshot create --help
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="Available commands")
    
    # Create command
    create_parser = subparsers.add_parser("create", help="Create a new plugin from template")
    create_parser.add_argument("name", help="Plugin name")
    create_parser.add_argument(
        "--language", "-l",
        choices=["python", "rust", "cpp"],
        default="python",
        help="Plugin language (default: python)"
    )
    create_parser.add_argument(
        "--output", "-o",
        type=Path,
        help="Output directory (default: ./plugins/{name})"
    )
    
    # Validate command
    validate_parser = subparsers.add_parser("validate", help="Validate a plugin manifest")
    validate_parser.add_argument("manifest", type=Path, help="Path to manifest.json")
    
    # Parse arguments
    args = parser.parse_args()
    
    # Execute command
    if args.command == "create":
        create_plugin(args.name, args.language, args.output)
    elif args.command == "validate":
        validate_manifest(args.manifest)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()
